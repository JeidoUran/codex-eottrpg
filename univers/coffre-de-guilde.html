<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Coffre de Guilde | Codex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../favicon.png" type="image/png">
  <link rel="stylesheet" href="../style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body>
<canvas id="particles"></canvas>

<header class="codex-header">
  <h1>Coffre de la Guilde</h1>
  <p class="sous-titre">Inventaire partagé des Égarés</p>
</header>

<nav class="nav-magique">
    <a href="/">Accueil</a>
    <a href="../notes/">Patch Notes</a>
    <a href="../regles/">Règles</a>
    <a href="../univers/">Univers</a>
    <a href="../musique">Musiques</a>
    <a href="../ressources/">Ressources</a>
    <a href="../credits">Crédits</a>
  </nav>

<main class="fiche-lore" style="flex-direction: column; align-items: center;">
  <article class="article-credits">
    <h2><i class="fa-solid fa-box-archive"></i> Contenu du coffre</h2>
    <ul class="image-list">
    <li class="ental-block">
      <div class="tooltip-wrapper">
      <img id="ental-icon" src="../../assets/images/ental.webp" class="ental-glow">
      <div class="tooltip">Entals stockés</div>
      </div>
    <strong><span id="gold-value">…</span> en</strong></li>
    <div class="inventory" id="chest-inventory">
      <em>Chargement de l'inventaire...</em>
    </div>
    <p class="last-updated timestamp">Chargement...</p>
</ul>
  </article>
</main>

<div class="backToTop-static-button">
  <button id="backToTop-static" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
    <i class="fa-solid fa-arrow-up"></i> Retour en haut
  </button>
</div>

<script>
const chestUrl = "https://s3.codex.eottrpg.memiroa.com/data/chest.json";

fetch(`${chestUrl}?nocache=${Date.now()}`)
  .then(res => res.json())
  .then(json => {
    const inventoryDiv = document.getElementById("chest-inventory");
    const allItems = json.data.items || [];
    const gold = json.data.system.currency?.gp ?? 0;
    document.getElementById("gold-value").textContent = gold.toLocaleString("fr-FR");

    const allowedTypes = ["container", "consumable", "equipment", "tool", "weapon", "loot"];
    const sortOrder = [ "etr", "shield", "helmet", "clothing", "light", "medium", "heavy", "gloves", "boots", "amulets", "rings", "potion", "scroll", "food", "material", "resource", "treasure", "key", "" ];

    const sortByType = (a, b) => {
      const aType = a.system?.type?.value ?? "";
      const bType = b.system?.type?.value ?? "";
      return sortOrder.indexOf(aType) - sortOrder.indexOf(bType);
    };

    const renderItem = item => {
      const match = item.img.match(/data\/assets\/(.+)/);
      const relativePath = match ? match[1] : "placeholder.png";
      const iconPath = `../assets/images/foundry-icons/${relativePath}`;
      const quantity = item.system?.quantity;
      const rarity = item.system?.rarity ?? "common";

      return `
        <div class="item rarity-${rarity}">
          <img src="${iconPath}" alt="${item.name}">
          ${quantity > 1 ? `<span class="quantity">${quantity}</span>` : ""}
          <div class="tooltip">${item.name}</div>
        </div>
      `;
    };

    const inventoryItems = allItems
      .filter(item => allowedTypes.includes(item.type))
      .sort(sortByType);

    inventoryDiv.innerHTML = inventoryItems.length > 0
      ? inventoryItems.map(renderItem).join("")
      : "<em>Le coffre est vide.</em>";

    const updated = new Date(json._codexLastUpdate);
    document.querySelector(".timestamp").textContent = "Dernière mise à jour : " + updated.toLocaleString("fr-FR", {
      dateStyle: "short", timeStyle: "short"
    });
  })
  .catch(err => {
    document.getElementById("chest-inventory").innerHTML = "<em>Données indisponibles. Le fichier JSON est introuvable ou le serveur est hors ligne.</em>";
    document.querySelector(".timestamp").textContent = "";
    console.error("Erreur chargement coffre :", err);
  });
</script>
<script src="../particles.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>F√©ril | Codex - Etrian Odyssey TTRPG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../../favicon.png" type="image/png">
  <link rel="stylesheet" href="../../style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body class="green-bg">
<canvas id="particles"></canvas>

<header class="codex-header">
  <img src="../../assets/images/portraits/feril.png" class="portrait-header" onclick="openLightbox(this.src)">
  <h1>F√©ril Waffenhalter</h1>
  <p class="sous-titre">Destructeur d'√©chiquiers</p>
</header>

<nav class="nav-magique">
  <a href="/">Accueil</a>
  <a href="../../notes/">Patch Notes</a>
  <a href="../../regles/">R√®gles</a>
  <a href="../../univers/">Univers</a>
  <a href="../../musique">Musiques</a>
  <a href="../../ressources/">Ressources</a>
  <a href="../../credits">Cr√©dits</a>
</nav>

<div class="header-links-center">
  <a href="../../univers/personnages/" class="carte-lien" style="display: inline-block; max-width: 300px;"><i class="fa-solid fa-arrow-left"></i> Index des personnages</a>
</div>

<div class="fiche-personnage">
<div class="fiche-stats">
  <article class="article-credits">
    <h2>Caract√©ristiques</h2>
    <ul class="image-list">
      <div class="stat-block">
        <li class="level-block">
          <div class="tooltip-wrapper">
            <img id="inspiration-icon" src="../../assets/images/inspiration-icons/inspiration-off.png" alt="Inspiration" class="inspiration-off">
            <div class="tooltip">Inspiration</div>
          </div>
         <h3>Niveau : <span id="level-value">?</span></h3></li>
        <div class="xp-bar-container">
          <div class="xp-bar-feril" id="xp-bar-feril" style="width: 0%"></div>
        </div>
        <small class="xp-text" id="xp-text">? / ?</small>
      </div> 
        <div class="image-texte" id="feril-stats">
          <em>Chargement des donn√©es de F√©ril...</em>
        </div>
    </ul>
  </article>
  <article class="article-credits">
    <h2>Inventaire</h2>
    <div class="inventory" id="feril-inventory">
      <em>Chargement de l'inventaire...</em>
    </div>
  </article>
    <p class="last-updated timestamp">Chargement...</p>
</div>

<div class="fiche-centrale">
<main class="fiche-lore">
  <article class="article-credits">
    <h2><i class="fa-solid fa-scroll"></i> F√©ril</h2>
    <ul class="image-list">
        <div class="image-texte">
          <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Race :</strong>Brouni</li>
          <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Classe :</strong> Souverain</li><br>
        </div>
     
      <li><img src="../../assets/images/notes-medium.png" class="image">
        <div class="image-texte">
          <strong>Biographie :</strong><br>
          Il est venu me d√©fier un soir sans lune, l‚Äôarmure encore poussi√©reuse, les cheveux en bataille comme les id√©es. Un Brouni √† la voix franche, √† la d√©marche d√©cid√©e. Ce genre de petit √™tre qu‚Äôon sous-estime trop souvent ‚Äî et qui finit par soulever des montagnes.<br><br>
          Je n‚Äôavais jamais vu un dragoon aussi... brouillon. Il s‚Äôinstalla √† la table d‚Äô√©checs comme on entre sur un champ de bataille : sans plan, sans recul, mais avec toute la fougue d‚Äôun premier assaut. Ses pi√®ces volaient, ses d√©cisions √©taient aussi brutales qu‚Äôimpulsives. Une temp√™te dans un gobelet d‚Äôeau. Et pourtant, quelque chose m‚Äôobligeait √† rester en alerte. Cette impr√©visibilit√©‚Ä¶ elle peut devenir dangereuse.<br><br>
          Il n‚Äôa pas gagn√©. Mais il n‚Äôa pas perdu non plus. Il a fait √©chec avec son roi. Un coup interdit, mais terriblement r√©v√©lateur : il n‚Äôaccepte pas les r√®gles si elles s‚Äôopposent √† sa volont√©. Je n‚Äôai pas eu le c≈ìur de le corriger. Il riait d√©j√†, convaincu d‚Äôavoir gagn√©. Peut-√™tre l‚Äôavait-il fait, d‚Äôune certaine mani√®re.<br><br>
          Je voulais lui parler apr√®s. Lui expliquer qu‚Äôun vrai chef apprend aussi √† perdre. Mais il avait d√©j√† quitt√© la pi√®ce ‚Äî et, je le crains, bien plus que cela. Ce n‚Äôest pas un soldat comme les autres. Et c‚Äôest pour √ßa que je me souviendrai de lui.
        </div>
      </li>
    </ul>
  </article>
</main>

<div class="backToTop-static-button">
  <button id="backToTop-static" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" aria-label="Retour en haut">
    <i class="fa-solid fa-arrow-up"></i> Retour en haut
  </button>
  </div>

</div>

<div class="fiche-skills">
</article>
<article class="article-credits">
  <h2>Aptitudes</h2>
  <div class="inventory" id="feril-features">
    <em>Chargement des aptitudes...</em>
  </div>
</article>

    <p class="last-updated timestamp">Chargement...</p>
</div>
</div>


<div id="lightbox" class="lightbox" onclick="closeLightbox()">
  <img id="lightbox-img" src="" alt="Portrait" />
</div>
<footer>
  <p>¬© 2025 ‚Ä¢ Wizardofaz, Rashaza, Jeido, ChatGPT</p>
</footer>
<script>
  const ferilUrl = "https://s3.codex.eottrpg.memiroa.com/data/feril.json";
  
  const url = new URL(ferilUrl);
  url.searchParams.set("nocache", Date.now());
  fetch(url)
    .then(res => res.json())
    .then(json => {
      const data = json.data;
      const abilities = data.system.abilities;
      const stats = document.getElementById("feril-stats");
      const inventoryDiv = document.getElementById("feril-inventory");
      const gold = json.data.system.currency?.gp ?? 0;
      const xp = data.system.details.xp?.value || 0;
      const levelTable = [
        0, 300, 900, 2700, 6500, 14000, 23000, 34000, 48000, 64000,
        85000, 100000, 120000, 140000, 165000, 195000, 225000, 265000, 305000
      ];
      const allItems = data.items || [];
      const allowedTypes = ["container", "consumable", "equipment", "tool", "weapon", "loot"];
      const sortOrder = [
          "etr",
          "shield",
          "tiara",
          "clothhat",
          "helmet",
          "heavyhelmet",
          "clothing",
          "light",
          "medium",
          "heavy",
          "gloves",
          "universalboots",
          "lightboots",
          "mediumboots",
          "heavyboots",
          "amulets",
          "rings",
          "essense",
          "potion",
          "thrown",
          "grenade",
          "ammo",
          "poison",
          "wand",
          "rod",
          "scroll",
          "food",
          "material",
          "resource",
          "treasure",
          "gem",
          "gear",
          "art",
          "furniture",
          "etrian",
          "trinket",
          "",
          "key"
        ];

        // Fonction de tri
        const sortByType = (a, b) => {
          const aType = a.system?.type?.value ?? "";
          const bType = b.system?.type?.value ?? "";
          const indexA = sortOrder.indexOf(aType);
          const indexB = sortOrder.indexOf(bType);
          return indexA - indexB;
        };

        const renderItem = item => {
          const match = item.img.match(/data\/assets\/(.+)/);
          const relativePath = match ? match[1] : "placeholder.png";
          const iconPath = `../../assets/images/foundry-icons/${relativePath}`;
          const quantity = item.system?.quantity;
          const rarity = item.system?.rarity ?? "common"; // fallback si manquant

          return `
            <div class="item rarity-${rarity}">
              <img src="${iconPath}" alt="${item.name}">
              ${quantity > 1 ? `<span class="quantity">${quantity}</span>` : ""}
              <div class="tooltip">${item.name}</div>
            </div>
          `;
        };
        
        const renderAbility = item => {
        const baseClassPage = "souverain";
        const baseRacePage = "brouni";
        const match = item.img.match(/data\/assets\/(.+)/);
        const relativePath = match ? match[1] : "placeholder.png";
        const iconPath = `../../assets/images/foundry-icons/${relativePath}`;
        const name = item.name;
        const level = item.system?.level ? ` (Niv. ${item.system.level})` : "";
        const cleanName = item.name.split(" - ")[0].split(" (")[0];
        const slug = cleanName
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");

          let origin = item.system?.requirements?.split(" ")[0]
          ?.toLowerCase()
          ?.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          ?? null;

        let link = "#";
        let isLinkValid = false;
        if (origin && slug) {
          if (item.system?.type?.value === "race") {
            link = `../../regles/races/${baseRacePage}.html#${slug}`;
            isLinkValid = true;
          } else if (item.system?.type?.value === "class") {
            link = `../../regles/classes/${baseClassPage}.html#${slug}`;
            isLinkValid = true;
          } else if (item.system?.type?.value === "oppatk") {
            link = `../../regles/generic-features.html#${slug}`;
            isLinkValid = true;
          } else if (!item.system?.type?.value) {
            link = `../../regles/generic-features.html#${slug}`;
            isLinkValid = true;
          }
        }


        let cssClass = "feature-generic";
        if (item.system?.type?.value === "race") cssClass = "feature-race";
        else if (item.system?.type?.value === "class") cssClass = "feature-class";

        return `
        <div class="item">
          ${isLinkValid
            ? `<a href="${link}" title="${name}${level}" target="_blank">
                <img src="${iconPath}" alt="${name}" class="${cssClass}">
              </a>`
            : `<div class="disabled-icon" title="${name}${level}">
                <img src="${iconPath}" alt="${name}" class="${cssClass}">
              </div>`
          }
          <div class="tooltip">${name}${level}</div>
        </div>
      `;
      };

        const featuresDiv = document.getElementById("feril-features");
        const features = data.items?.filter(item =>
          (item.type === "feat" || item.type === "classFeature") &&
          item.img && item.name
        ) || [];

        featuresDiv.innerHTML = `
          <div class="inventory">
            ${features.map(renderAbility).join("")}
          </div>
        `;

        const equippedItems = allItems
          .filter(item => item.system?.equipped === true && allowedTypes.includes(item.type))
          .sort(sortByType);

        const inventoryItems = allItems
          .filter(item => item.system?.equipped !== true && allowedTypes.includes(item.type))
          .sort(sortByType);

      let html = `
          <div class="inventory-section">
            <li class="character-stats" style="display: flex; align-items: flex-start; gap: 0.75rem; list-style: none;"><img src="../../assets/images/notes-medium.png" class="image" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;"><strong>√âquip√© :</strong></li>
            <div class="inventory equipped-inventory">
              ${equippedItems.length > 0 ? equippedItems.map(renderItem).join("") : "<em>Aucun objet √©quip√©.</em>"}
            </div>
          </div>
          <div class="inventory-section">
            <li class="character-stats" style="display: flex; align-items: flex-start; gap: 0.75rem; list-style: none;"><img src="../../assets/images/notes-medium.png" class="image" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;"><strong>Sac :</strong></li>
            <ul class="image-list">
            <li class="ental-block">
            <img id="ental-icon" src="../../assets/images/ental.webp" class="ental-glow">
            <strong><span id="gold-value">‚Ä¶</span> en</strong></li></ul>
            <div class="inventory bag-inventory">
              ${inventoryItems.length > 0 ? inventoryItems.map(renderItem).join("") : "<em>Inventaire vide.</em>"}
            </div>
          </div>
        `;

      inventoryDiv.innerHTML = html;

      if (!data.system || !data.system.attributes || !data.system.abilities) {
        stats.innerHTML = "<em>Donn√©es de F√©ril incompl√®tes.</em>";
        return;
      }
      
      let level = 1;
      for (let i = 1; i < levelTable.length; i++) {
        if (xp < levelTable[i]) {
          level = i;
          break;
        }
      }

      const hasInspiration = data.system?.attributes?.inspiration;
      const inspirationImg = document.getElementById("inspiration-icon");
      const inspirationTooltip = inspirationImg.nextElementSibling;

      if (hasInspiration) {
        inspirationImg.src = "../../assets/images/inspiration-icons/inspiration-on.png";
        inspirationImg.className = "inspiration-icon inspiration-glow";
        inspirationTooltip.textContent = "Inspiration";
      } else {
        inspirationImg.src = "../../assets/images/inspiration-icons/inspiration-off.png";
        inspirationImg.className = "inspiration-icon inspiration-off";
        inspirationTooltip.textContent = "Pas d'inspiration";
      }

      document.getElementById("gold-value").textContent = gold.toLocaleString("fr-FR");

      // Mise √† jour du niveau
      document.getElementById("level-value").textContent = level;

      // Mise √† jour de la barre
      const xpMin = levelTable[level - 1];
      const xpMax = levelTable[level];
      const ratio = (xp - xpMin) / (xpMax - xpMin);
      document.getElementById("xp-bar-feril").style.width = `${Math.round(ratio * 100)}%`;
      document.getElementById("xp-text").textContent = `${xp} / ${xpMax}`;

      stats.innerHTML = `
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>PV :</strong> ${data.system.attributes.hp.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Force :</strong> ${abilities.str.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Dext√©rit√© :</strong> ${abilities.dex.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Constitution :</strong> ${abilities.con.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Intelligence :</strong> ${abilities.int.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Sagesse :</strong> ${abilities.wis.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Charisme :</strong> ${abilities.cha.value ?? "?"}</li>
      `;

      const updated = new Date(json._codexLastUpdate);
      document.querySelectorAll(".last-updated").forEach(el => {
        el.textContent = "Derni√®re mise √† jour : " + updated.toLocaleString("fr-FR", {
          dateStyle: "short",
          timeStyle: "short"
        });
      });
      }) // üëà fermeture du .then
      .catch(err => {
        console.error("Erreur lors du chargement des donn√©es F√©ril :", err);
        document.getElementById("feril-stats").innerHTML =
          "<em>Donn√©es indisponibles. Le fichier JSON n'a pas √©t√© trouv√© ou le serveur est hors ligne.</em>";
        document.querySelectorAll(".last-updated").forEach(el => el.textContent = "");
      });
  </script>  
<script>
  function openLightbox(src) {
    const lightbox = document.getElementById("lightbox");
    const img = document.getElementById("lightbox-img");
    img.src = src;
    lightbox.style.display = "flex";
  }

  function closeLightbox() {
    document.getElementById("lightbox").style.display = "none";
  }
</script>
<script src="../../particles.js"></script>
</body>
</html>
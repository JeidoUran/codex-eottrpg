<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <title>Codex - Etrian Odyssey TTRPG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="stylesheet" href="../style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
  </head>
  <body>
    <canvas id="particles"></canvas>
    <header class="codex-header">
      <img src="../assets/images/banniere.png" alt="Bannière" class="banniere">
      <h1>Codex du JDR Etrian Odyssey</h1>
      <p class="sous-titre">Archives et mises à jour du monde d’Etrian Odyssey</p>
    </header>
    <nav class="nav-magique">
      <a href="/">Accueil</a>
      <a href="../notes/">Patch Notes</a>
      <a href="../regles/">Règles</a>
      <a href="../regles/classes/">Classes</a>
      <a href="../univers/">Univers</a>
      <a href="">Musiques</a>
      <a href="../ressources/">Ressources</a>
      <a href="../credits/">Crédits</a>
    </nav>
    
    <main class="accueil-music">
      <section class="music-player">
        <div class="audio-player-container">
          <div class="now-playing">
            <img id="track-art" src="default-cover.jpg" alt=" " class="track-cover">
            <div>
              <h3 id="track-title"></h3>
              <p id="track-artist"></p>
            </div>
          </div>
          <audio id="audio" preload="auto"> Votre navigateur ne supporte pas l'élément audio. </audio>
          <div class="controls">
            <button id="prevBtn">
              <i class="fa-solid fa-backward"></i>
            </button>
            <button id="playPauseBtn">
              <i class="fa-solid fa-play"></i>
            </button>
            <button id="nextBtn">
              <i class="fa-solid fa-forward"></i>
            </button>
          </div>
          <div class="time">
            <div id="timeDisplay">0:00</div>
            <div id="totalTimeDisplay">0:00</div>
          </div>
          <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
          </div>
          <div class="volume-container">
            <i id="volumeIcon" class="fas fa-volume-high"></i>
            <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
            <span id="track-context" class="track-context"></span>
          </div>
        </div>
        <div class="playlist-tabs-wrapper">
          <button class="scroll-btn left">
            <i class="fas fa-chevron-left"></i>
          </button>
          <div class="playlist-tabs-container">
            <div class="playlist-tabs" id="playlistTabs">
              <button class="tab-button active" data-playlist="sys">Système</button>
              <button class="tab-button" data-playlist="charamake">Création</button>
              <button class="tab-button" data-playlist="city">Voarmur</button>
              <button class="tab-button" data-playlist="events">Évènements</button>
              <button class="tab-button" data-playlist="labyrinth">Labyrinthe</button>
              <button class="tab-button" data-playlist="battle">Combats</button>
              <button class="tab-button" data-playlist="foe">F.O.E</button>
              <button class="tab-button" data-playlist="boss">Boss</button>
            </div>
          </div>
          <button class="scroll-btn right">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        </div>
        <ul id="playlist"></ul>
        </div>
      </section>
    </main>
    <footer>
      <p>© 2025 • Wizardofaz, Rashaza, Jeido, ChatGPT</p>
    </footer>
    <script>
      const audio = document.getElementById('audio');
      const playlistData = {
        sys: [{
          src: "https://s3.codex.eottrpg.memiroa.com/audio/sys/eo3-title.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "L'écran titre"
        }],
        charamake: [{
          src: "https://s3.codex.eottrpg.memiroa.com/audio/guild/eo1u-guild.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "La création de personnage"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/guild/eo2u-guild.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "La création de personnage"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/guild/eo3-guild-arrange.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "La création de personnage"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/guild/eo4-guild.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "La création de personnage"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/guild/eo5-guild.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "La création de personnage"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/guild/eon-guild.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "La création de personnage"
        }],
        city: [{
          src: "https://s3.codex.eottrpg.memiroa.com/audio/city/eo3-city-day-concert.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Voarmur - Jour"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/city/eo3-city-night-remix.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Voarmur - Nuit"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/guild/eo3-guild-arrange.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "Voarmur - Guilde des Aventuriers"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/city/eo2u-palace.mp3",
          fallbackCover: "cover-sys.jpg",
          context: "Voarmur - Palais du Sénat"
        }],
        events: [{
          src: "https://s3.codex.eottrpg.memiroa.com/audio/city/eo1u-house.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Préparations au Refuge des Vents Errants"
        }],
        labyrinth: [{
          src: "https://s3.codex.eottrpg.memiroa.com/audio/dungeon/eo3-dungeon1-remix.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "La 1ère Strate - Le Bois de la Cascade"
        }],
        battle: [{
          src: "https://s3.codex.eottrpg.memiroa.com/audio/battle/first/eo1u-battle-first.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Combat contre des monstres"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/battle/first/eo2u-battle-first.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Combat contre des monstres"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/battle/first/eo3-battle-first-remix.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Combat contre des monstres"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/battle/first/eo4-battle-first.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Combat contre des monstres"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/battle/first/eo5-battle-first.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Combat contre des monstres"
        }, {
          src: "https://s3.codex.eottrpg.memiroa.com/audio/battle/first/eon-battle-first.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Combat contre des monstres"
        }],
        foe: [],
        boss: [{
          src: "https://s3.codex.eottrpg.memiroa.com/audio/battle/boss/eo2u-battle-boss.mp3",
          fallbackCover: "cover-explore.jpg",
          context: "Combat contre le Grand lynx α"
        }]
      };
      let trackElements = [];
      let currentTrackIndex = 0;
      let currentPlaylist = 'town';
      const playlist = document.getElementById('playlist');
      // Remplir la playlist dynamiquement
      function loadPlaylist(playlistKey) {
        const tracks = playlistData[playlistKey];
        playlist.classList.remove('visible');
        setTimeout(() => {
          playlist.innerHTML = "";
          trackElements = [];
          currentPlaylist = playlistKey;
          const tagReaders = tracks.map((track, index) => {
            return new Promise((resolve) => {
              window.jsmediatags.read(track.src, {
                onSuccess: function(tag) {
                  const title = tag.tags.title || `Piste ${index + 1}`;
                  const artist = tag.tags.artist || "Artiste inconnu";
                  let imageUrl = track.fallbackCover;
                  if (tag.tags.picture) {
                    const {
                      data,
                      format
                    } = tag.tags.picture;
                    const base64String = data.map(byte => String.fromCharCode(byte)).join('');
                    imageUrl = `data:${format};base64,${btoa(base64String)}`;
                  }
                  resolve({
                    index,
                    src: track.src,
                    title,
                    artist,
                    imageUrl,
                    context: track.context || ""
                  });
                },
                onError: function(error) {
                  console.warn("Erreur lecture des tags :", error);
                  resolve({
                    index,
                    src: track.src,
                    title: `Piste ${index + 1}`,
                    artist: "Artiste inconnu",
                    imageUrl: track.fallbackCover,
                    context: track.context || ""
                  });
                }
              });
            });
          });
          Promise.all(tagReaders).then(results => {
            // Tri par index (juste au cas où)
            results.sort((a, b) => a.index - b.index);
            results.forEach((trackData, i) => {
              const li = document.createElement("li");
              li.dataset.src = trackData.src;
              li.dataset.title = trackData.title;
              li.dataset.artist = trackData.artist;
              li.dataset.cover = trackData.imageUrl;
              li.dataset.context = trackData.context;
              li.innerHTML = `
      
									<img src="${trackData.imageUrl}" class="playlist-cover" alt=" ">
										<div class="playlist-info">
											<strong>${trackData.title}</strong>
											<br>
												<span>${trackData.artist}</span>
											</div>
      `;
              li.addEventListener("click", () => {
                playTrack(i);
                document.getElementById('playPauseBtn').innerHTML = ' < i class = "fas fa-pause" > < /i>';
              });
              playlist.appendChild(li);
              trackElements.push(li);
            });
            // fade-in après ajout
            setTimeout(() => {
              playlist.classList.add('visible');
            }, 50);
          });
        }, 300); // Attendre la transition fade-out
      }
      // Gestion des onglets
      document.querySelectorAll(".tab-button").forEach(btn => {
        btn.addEventListener("click", () => {
          document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          loadPlaylist(btn.dataset.playlist);
        });
      });
      // Charger la playlist par défaut au démarrage
      loadPlaylist(currentPlaylist);
      const trackTitle = document.getElementById('track-title');
      const trackArtist = document.getElementById('track-artist');
      const trackArt = document.getElementById('track-art');
      const playBtn = document.getElementById('playPauseBtn');
      const progressBar = document.getElementById('progressBar');
      const timeDisplay = document.getElementById('timeDisplay');
      const progressContainer = document.querySelector('.progress-container');

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
      }
      audio.addEventListener('timeupdate', () => {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = `${progress}%`;
        timeDisplay.textContent = formatTime(audio.currentTime);
      });
      playBtn.addEventListener('click', () => {
        if (audio.paused) {
          audio.play();
          playBtn.innerHTML = ' < i class = "fas fa-pause" > < /i>';
        } else {
          audio.pause();
          playBtn.innerHTML = ' < i class = "fas fa-play" > < /i>';
        }
      });
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      // Récupère les pistes
      // const tracks = [...playlist.querySelectorAll('li')];
      // let currentTrackIndex = tracks.findIndex(li => li.dataset.src === audio.src);
      // Joue une piste donnée
      function playTrack(index) {
        const totalTimeDisplay = document.getElementById('totalTimeDisplay');
        const track = trackElements[index];
        if (!track) return;
        const trackContext = document.getElementById('track-context');
        trackContext.textContent = track.dataset.context || "";
        currentTrackIndex = index;
        audio.src = track.dataset.src;
        // Attendre que les métadonnées soient chargées
        audio.addEventListener("loadedmetadata", () => {
          totalTimeDisplay.textContent = formatTime(audio.duration);
        }, {
          once: true
        }); // ⚠️ important : une seule fois, sinon ça s'empile !
        audio.play();
        // Mise à jour visuelle
        trackElements.forEach(t => t.classList.remove('playing'));
        track.classList.add('playing');
        trackTitle.textContent = track.dataset.title || "Titre inconnu";
        trackArtist.textContent = track.dataset.artist || "Artiste inconnu";
        trackArt.src = track.dataset.cover || "cover.jpg";
      }
      // Bouton précédent
      prevBtn.addEventListener('click', () => {
        if (currentTrackIndex > 0) {
          playTrack(currentTrackIndex - 1);
        } else {
          playTrack(tracks.length - 1); // Boucle en arrière
        }
      });
      // Bouton suivant
      nextBtn.addEventListener('click', () => {
        if (currentTrackIndex < tracks.length - 1) {
          playTrack(currentTrackIndex + 1);
        } else {
          playTrack(0); // Boucle au début
        }
      });
      // Quand une piste est cliquée dans la playlist
      playlist.addEventListener('click', e => {
        const li = e.target.closest('li');
        if (!li || !playlist.contains(li)) return;
        const clickedIndex = tracks.indexOf(li);
        playTrack(clickedIndex);
      });
      const volumeSlider = document.getElementById('volumeSlider');
      const volumeIcon = document.getElementById('volumeIcon');
      // Appliquer la valeur du slider au démarrage
      window.addEventListener("DOMContentLoaded", () => {
        const initialVolume = parseFloat(volumeSlider.value || 1);
        audio.volume = initialVolume;
        // Met à jour l'icône si besoin
        if (initialVolume === 0) {
          volumeIcon.className = 'fas fa-volume-xmark';
        } else if (initialVolume < 0.5) {
          volumeIcon.className = 'fas fa-volume-low';
        } else {
          volumeIcon.className = 'fas fa-volume-high';
        }
      });
      let lastVolume = volumeSlider.value;
      volumeSlider.addEventListener('input', () => {
        audio.volume = volumeSlider.value;
        // Sauvegarde du volume si non nul
        if (volumeSlider.value > 0) lastVolume = volumeSlider.value;
        // Changement d’icône en fonction du volume
        if (audio.volume == 0) {
          volumeIcon.className = 'fas fa-volume-xmark';
        } else if (audio.volume < 0.5) {
          volumeIcon.className = 'fas fa-volume-low';
        } else {
          volumeIcon.className = 'fas fa-volume-high';
        }
      });
      volumeIcon.addEventListener('click', () => {
        if (audio.volume > 0) {
          lastVolume = audio.volume;
          audio.volume = 0;
          volumeSlider.value = 0;
          volumeIcon.className = 'fas fa-volume-xmark';
        } else {
          audio.volume = lastVolume || 1;
          volumeSlider.value = audio.volume;
          volumeIcon.className = audio.volume < 0.5 ? 'fas fa-volume-low' : 'fas fa-volume-high';
        }
      });
      progressContainer.addEventListener('click', (e) => {
        const rect = progressContainer.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        const newTime = (clickX / width) * audio.duration;
        audio.currentTime = newTime;
      });
      playlist.addEventListener('click', e => {
        if (e.target.tagName === 'LI') {
          audio.src = e.target.dataset.src;
          audio.play();
          trackTitle.textContent = e.target.dataset.title || "Titre inconnu";
          trackArtist.textContent = e.target.dataset.artist || "Artiste inconnu";
          trackArt.src = e.target.dataset.cover || "cover.jpg";
        }
      });
    </script>
    <script>
      function loadTagsFromUrl(mp3Url) {
        window.jsmediatags.read(mp3Url, {
          onSuccess: function(tag) {
            const picture = tag.tags.picture;
            if (picture) {
              const base64String = picture.data.map(byte => String.fromCharCode(byte)).join('');
              const imageUrl = `data:${picture.format};base64,${btoa(base64String)}`;
              // Affiche la pochette
              document.getElementById('track-art').src = imageUrl;
            }
            if (tag.tags.title) {
              document.getElementById('track-title').textContent = tag.tags.title;
            }
            if (tag.tags.artist) {
              document.getElementById('track-artist').textContent = tag.tags.artist;
            }
          },
          onError: function(error) {
            console.warn('Erreur de lecture des tags :', error);
          }
        });
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const defaultTab = document.querySelector('.tab-button[data-playlist="sys"]');
        if (defaultTab) defaultTab.click();
        // Forcer le scroll au tout début
        const tabsContainer = document.querySelector('.playlist-tabs-container');
        tabsContainer.scrollLeft = 0;
      });
    </script>
    <script>
      const scrollBtns = document.querySelectorAll('.scroll-btn');
      const scrollContainer = document.querySelector('.playlist-tabs-container');
      scrollBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const scrollAmount = 150;
          if (btn.classList.contains('left')) {
            scrollContainer.scrollBy({
              left: -scrollAmount,
              behavior: 'smooth'
            });
          } else {
            scrollContainer.scrollBy({
              left: scrollAmount,
              behavior: 'smooth'
            });
          }
        });
      });
    </script>
    <script src="particles.js"></script>
  </body>
</html>
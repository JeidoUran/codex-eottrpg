<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Ithil | Codex - Etrian Odyssey TTRPG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="../../favicon.png" type="image/png">
  <link rel="stylesheet" href="../../style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>
<body class="red-bg">
<canvas id="particles"></canvas>

<header class="codex-header">
  <img src="../../assets/images/portraits/ithil.png" class="portrait-header" onclick="openLightbox(this.src)">
  <h1>Ithil</h1>
  <p class="sous-titre">Émissaire des défunts</p>
</header>

<nav class="nav-magique">
  <a href="/">Accueil</a>
  <a href="../../notes/">Patch Notes</a>
  <a href="../../rules/">Règles</a>
  <a href="../../lore/">Univers</a>
  <a href="../../music-player.html">Musiques</a>
  <a href="../../resources/">Ressources</a>
  <a href="../../credits.html">Crédits</a>
</nav>

<div class="header-links-center">
  <a href="../../lore/characters/" class="carte-lien" style="display: inline-block; max-width: 300px;"><i class="fa-solid fa-arrow-left"></i> Index des personnages</a>
</div>

<div class="fiche-personnage">
<div class="fiche-stats">
  <article class="article-credits">
    <h2>Caractéristiques</h2>
    <ul class="image-list">
      <div class="stat-block">
        <li class="level-block">
          <div class="tooltip-wrapper">
            <img id="inspiration-icon" src="../../assets/images/inspiration-icons/inspiration-off.png" alt="Inspiration" class="inspiration-off">
            <div class="tooltip">Inspiration</div>
          </div>
         <h3>Niveau : <span id="level-value">?</span></h3></li>
        <div class="xp-bar-container">
          <div class="xp-bar-ithil" id="xp-bar-ithil" style="width: 0%"></div>
        </div>
        <small class="xp-text" id="xp-text">? / ?</small>
      </div>      
        <div class="image-texte" id="ithil-stats">
          <em>Chargement des données d'Ithil...</em>
        </div>
    </ul>
  </article>
  <article class="article-credits">
    <h2>Inventaire</h2>
    <div class="inventory" id="ithil-inventory">
      <em>Chargement de l'inventaire...</em>
    </div>
  </article>
    <p class="last-updated timestamp">Chargement...</p>
</div>

<div class="fiche-centrale">
<main class="fiche-lore">
  <article class="article-credits">
    <h2><i class="fa-solid fa-scroll"></i> Ithil</h2>
    <ul class="image-list">
        <div class="image-texte">
          <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Race :</strong>Célestrien</li>
          <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Classe :</strong> Vagabond</li><br>
        </div>
     
      <li><img src="../../assets/images/notes-medium.png" class="image">
        <div class="image-texte">
          <strong>Biographie :</strong><br>
          Elle entre toujours la première, seule, sans un mot. Ce que les autres fuient, Ithil s’y rend comme on s’assoit à table : en connaisseuse résignée. La mort, les chairs éclatées, les silences lourds de malédictions… ce ne sont pas des obstacles, ce sont ses compagnons d’enquête.<br><br>
          On murmure qu’elle parle avec les morts. Mais ce qu’on oublie, c’est que les morts parlent rarement de choses agréables.<br><br>
          Autrefois soldate, aujourd’hui médium désabusée, elle loue ses dons à la garde, remontant les traces de sang et les regrets jusqu’aux pires coins de la ville. Quand elle lève la main, ce n’est pas pour combattre : c’est pour appeler ce qu’il reste d’une âme, et interroger ce qui n’a pas su partir en paix. Et quand elle claque des doigts, c’est pour libérer ce qui n’aurait jamais dû rester.<br><br>
          Ithil ne pleure plus. Elle n’espère plus. Elle compte les morts comme d’autres comptent leurs primes, sachant qu’aucun d’eux ne viendra la remercier. Mais parfois, dans la nuit, elle regarde la lune comme on cherche un point fixe au bord du gouffre, et elle murmure à l’ombre :<br>
          “Demain, je les reverrai tous. J’ai fait cette promesse… alors j’y retournerai.”
        </div>
      </li>
    </ul>
  </article>
</main>

<div class="backToTop-static-button">
  <button id="backToTop-static" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })" aria-label="Retour en haut">
    <i class="fa-solid fa-arrow-up"></i> Retour en haut
  </button>
  </div>

</div>

<div class="fiche-skills">
</article>
<article class="article-credits">
  <h2>Aptitudes</h2>
  <div class="inventory" id="ithil-features">
    <em>Chargement des aptitudes...</em>
  </div>
</article>

    <p class="last-updated timestamp">Chargement...</p>
</div>
</div>


<div id="lightbox" class="lightbox" onclick="closeLightbox()">
  <img id="lightbox-img" src="" alt="Portrait" />
</div>
<footer>
  <p>© 2025 • Wizardofaz, Rashaza, Jeido, ChatGPT</p>
</footer>
<script>
  const ithilUrl = "https://s3.codex.eottrpg.memiroa.com/data/ithil.json";
  
  const url = new URL(ithilUrl);
  url.searchParams.set("nocache", Date.now());
  fetch(url)
    .then(res => res.json())
    .then(json => {
      const data = json.data;
      const abilities = data.system.abilities;
      const stats = document.getElementById("ithil-stats");
      const inventoryDiv = document.getElementById("ithil-inventory");
      const gold = json.data.system.currency?.gp ?? 0;
      const xp = data.system.details.xp?.value || 0;
      const levelTable = [
        0, 300, 900, 2700, 6500, 14000, 23000, 34000, 48000, 64000,
        85000, 100000, 120000, 140000, 165000, 195000, 225000, 265000, 305000
      ];
      const allItems = data.items || [];
      const allowedTypes = ["container", "consumable", "equipment", "tool", "weapon", "loot"];
      const sortOrder = [
          "etr",
          "shield",
          "tiara",
          "clothhat",
          "helmet",
          "heavyhelmet",
          "clothing",
          "light",
          "medium",
          "heavy",
          "gloves",
          "universalboots",
          "lightboots",
          "mediumboots",
          "heavyboots",
          "amulets",
          "rings",
          "essense",
          "potion",
          "thrown",
          "grenade",
          "ammo",
          "poison",
          "wand",
          "rod",
          "scroll",
          "food",
          "material",
          "resource",
          "treasure",
          "gem",
          "gear",
          "art",
          "furniture",
          "etrian",
          "trinket",
          "",
          "key"
        ];

        // Fonction de tri
        const sortByType = (a, b) => {
          const aType = a.system?.type?.value ?? "";
          const bType = b.system?.type?.value ?? "";
          const indexA = sortOrder.indexOf(aType);
          const indexB = sortOrder.indexOf(bType);
          return indexA - indexB;
        };

        const renderItem = item => {
          const match = item.img.match(/data\/assets\/(.+)/);
          const relativePath = match ? match[1] : "placeholder.png";
          const iconPath = `../../assets/images/foundry-icons/${relativePath}`;
          const quantity = item.system?.quantity;
          const rarity = item.system?.rarity ?? "common"; // fallback si manquant

          return `
            <div class="item rarity-${rarity}">
              <img src="${iconPath}" alt="${item.name}">
              ${quantity > 1 ? `<span class="quantity">${quantity}</span>` : ""}
              <div class="tooltip">${item.name}</div>
            </div>
          `;
        };
        
        const renderAbility = item => {
        const baseClassPage = "rover";
        const baseRacePage = "celestrian";
        const match = item.img.match(/data\/assets\/(.+)/);
        const relativePath = match ? match[1] : "placeholder.png";
        const iconPath = `../../assets/images/foundry-icons/${relativePath}`;
        const name = item.name;
        const level = item.system?.level ? ` (Niv. ${item.system.level})` : "";
        const cleanName = item.name.split(" - ")[0].split(" (")[0];
        const slug = cleanName
          .toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9]+/g, "-")
          .replace(/(^-|-$)/g, "");

          let origin = item.system?.requirements?.split(" ")[0]
          ?.toLowerCase()
          ?.normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          ?? null;

        let link = "#";
        let isLinkValid = false;
        if (origin && slug) {
          if (item.system?.type?.value === "race") {
            link = `../../rules/races/${baseRacePage}.html#${slug}`;
            isLinkValid = true;
          } else if (item.system?.type?.value === "class") {
            link = `../../rules/classes/${baseClassPage}.html#${slug}`;
            isLinkValid = true;
          } else if (item.system?.type?.value === "oppatk") {
            link = `../../rules/generic-features.html#${slug}`;
            isLinkValid = true;
          } else if (!item.system?.type?.value) {
            link = `../../rules/generic-features.html#${slug}`;
            isLinkValid = true;
          }
        }


        let cssClass = "feature-generic";
        if (item.system?.type?.value === "race") cssClass = "feature-race";
        else if (item.system?.type?.value === "class") cssClass = "feature-class";

        return `
        <div class="item">
          ${isLinkValid
            ? `<a href="${link}" title="${name}${level}" target="_blank">
                <img src="${iconPath}" alt="${name}" class="${cssClass}">
              </a>`
            : `<div class="disabled-icon" title="${name}${level}">
                <img src="${iconPath}" alt="${name}" class="${cssClass}">
              </div>`
          }
          <div class="tooltip">${name}${level}</div>
        </div>
      `;
      };

        const featuresDiv = document.getElementById("ithil-features");
        const features = data.items?.filter(item =>
          (item.type === "feat" || item.type === "classFeature") &&
          item.img && item.name
        ) || [];

        featuresDiv.innerHTML = `
          <div class="inventory">
            ${features.map(renderAbility).join("")}
          </div>
        `;

        const equippedItems = allItems
          .filter(item => item.system?.equipped === true && allowedTypes.includes(item.type))
          .sort(sortByType);

        const inventoryItems = allItems
          .filter(item => item.system?.equipped !== true && allowedTypes.includes(item.type))
          .sort(sortByType);

      let html = `
          <div class="inventory-section">
            <li class="character-stats" style="display: flex; align-items: flex-start; gap: 0.75rem; list-style: none;"><img src="../../assets/images/notes-medium.png" class="image" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;"><strong>Équipé :</strong></li>
            <div class="inventory equipped-inventory">
              ${equippedItems.length > 0 ? equippedItems.map(renderItem).join("") : "<em>Aucun objet équipé.</em>"}
            </div>
          </div>
          <div class="inventory-section">
            <li class="character-stats" style="display: flex; align-items: flex-start; gap: 0.75rem; list-style: none;"><img src="../../assets/images/notes-medium.png" class="image" style="width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px;"><strong>Sac :</strong></li>
            <ul class="image-list">
            <li class="ental-block">
            <img id="ental-icon" src="../../assets/images/ental.webp" class="ental-glow">
            <strong><span id="gold-value">…</span> en</strong></li></ul>
            <div class="inventory bag-inventory">
              ${inventoryItems.length > 0 ? inventoryItems.map(renderItem).join("") : "<em>Inventaire vide.</em>"}
            </div>
          </div>
        `;

      inventoryDiv.innerHTML = html;

      if (!data.system || !data.system.attributes || !data.system.abilities) {
        stats.innerHTML = "<em>Données d'Ithil incomplètes.</em>";
        return;
      }
      
      let level = 1;
      for (let i = 1; i < levelTable.length; i++) {
        if (xp < levelTable[i]) {
          level = i;
          break;
        }
      }

      const hasInspiration = data.system?.attributes?.inspiration;
      const inspirationImg = document.getElementById("inspiration-icon");
      const inspirationTooltip = inspirationImg.nextElementSibling;

      if (hasInspiration) {
        inspirationImg.src = "../../assets/images/inspiration-icons/inspiration-on.png";
        inspirationImg.className = "inspiration-icon inspiration-glow";
        inspirationTooltip.textContent = "Inspiration";
      } else {
        inspirationImg.src = "../../assets/images/inspiration-icons/inspiration-off.png";
        inspirationImg.className = "inspiration-icon inspiration-off";
        inspirationTooltip.textContent = "Pas d'inspiration";
      }

      document.getElementById("gold-value").textContent = gold.toLocaleString("fr-FR");

      // Mise à jour du niveau
      document.getElementById("level-value").textContent = level;

      // Mise à jour de la barre
      const xpMin = levelTable[level - 1];
      const xpMax = levelTable[level];
      const ratio = (xp - xpMin) / (xpMax - xpMin);
      document.getElementById("xp-bar-ithil").style.width = `${Math.round(ratio * 100)}%`;
      document.getElementById("xp-text").textContent = `${xp} / ${xpMax}`;

      stats.innerHTML = `
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>PV :</strong> ${data.system.attributes.hp.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Force :</strong> ${abilities.str.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Dextérité :</strong> ${abilities.dex.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Constitution :</strong> ${abilities.con.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Intelligence :</strong> ${abilities.int.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Sagesse :</strong> ${abilities.wis.value ?? "?"}</li>
        <li class="character-stats"><img src="../../assets/images/notes-medium.png" class="image"><strong>Charisme :</strong> ${abilities.cha.value ?? "?"}</li>
      `;

      const updated = new Date(json._codexLastUpdate);
      document.querySelectorAll(".last-updated").forEach(el => {
        el.textContent = "Dernière mise à jour : " + updated.toLocaleString("fr-FR", {
          dateStyle: "short",
          timeStyle: "short"
        });
      });
      }) // 👈 fermeture du .then
      .catch(err => {
        console.error("Erreur lors du chargement des données Ithil :", err);
        document.getElementById("ithil-stats").innerHTML =
          "<em>Données indisponibles. Le fichier JSON n'a pas été trouvé ou le serveur est hors ligne.</em>";
        document.querySelectorAll(".last-updated").forEach(el => el.textContent = "");
      });
  </script>  
<script>
  function openLightbox(src) {
    const lightbox = document.getElementById("lightbox");
    const img = document.getElementById("lightbox-img");
    img.src = src;
    lightbox.style.display = "flex";
  }

  function closeLightbox() {
    document.getElementById("lightbox").style.display = "none";
  }
</script>
<script src="../../particles.js"></script>
</body>
</html>